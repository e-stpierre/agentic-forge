name: Claude Code Review

on:
  pull_request:
    types: [opened]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Review this pull request for the agentic-forge repository - a collection of modular extensions for Claude Code.

            ## Repository-Specific Validation Rules

            ### 1. Plugin Structure & Placement
            - Commands must be in `/commands/` as `.md` files
            - Agents must be in `/agents/`
            - Skills must be in `/skills/`
            - Hooks must be in `/hooks/`
            - Templates must be in `/templates/`
            - Documentation must be in `/docs/`
            - Examples must be in `/examples/`

            ### 2. Naming Conventions (CRITICAL)
            - **Commands**: kebab-case (e.g., `review-pr.md`, `setup-tests.md`)
            - **Agents**: descriptive names with domain prefix (e.g., `devops-agent.md`, `test-agent.md`)
            - **Skills**: verb-noun format (e.g., `parse-logs`, `validate-config`)
            - **Hooks**: include event name (e.g., `session-start-hook.sh`, `tool-call-hook.sh`)
            - **Templates**: use project type (e.g., `nodejs-template`, `python-template`)

            ### 3. File Format Requirements
            - Commands: Markdown (`.md`) files only
            - Agents: Markdown or YAML
            - Skills: Markdown (`.md`) with structured prompts
            - Hooks: Shell scripts (`.sh`) or executable programs
            - Templates: Complete directory structures with config files

            ### 4. Documentation Standards
            - **Plugin READMEs**: Only plugin-specific information, no duplication from root README
            - **No duplication**: Don't repeat installation, marketplace setup, contributing guidelines, license info
            - **CHANGELOGs**: Brief, focus on what changed not why
            - **ASCII only**: Use only valid ASCII characters to avoid encoding issues
            - **Link to root docs**: Reference root README or `/docs/` for general information

            ### 5. Plugin Quality Requirements

            **Commands must have:**
            - Clear, descriptive names
            - Usage examples
            - Comprehensive documentation
            - Graceful edge case handling

            **Agents must have:**
            - Specific domain focus (DevOps, testing, documentation, etc.)
            - Well-defined capabilities and limitations
            - Clear invocation instructions
            - Example use cases

            **Skills must have:**
            - Modular, single-purpose design
            - Context-independent operation
            - Clear input/output contracts
            - Composability with other skills

            **Hooks must have:**
            - Lightweight, performant implementation
            - Graceful error handling
            - Clear event/trigger documentation
            - Configuration options

            **Templates must have:**
            - Complete `.claude/` directory structure
            - Sensible defaults
            - Customization documentation
            - Coverage of common use cases

            ### 6. General Code Quality Principles
            - **Modularity**: Each plugin does one thing well
            - **Composability**: Plugins work together seamlessly
            - **Documentation**: Every plugin has clear usage instructions
            - **Error Handling**: Fail gracefully with helpful error messages
            - **Performance**: Keep plugins lightweight and efficient
            - **Security**: No injection vulnerabilities, no hardcoded secrets

            ### 7. Technical Considerations
            - Hooks should be lightweight (they run frequently)
            - Use clear, descriptive names throughout
            - Comment complex logic
            - Keep files focused and modular
            - Test across different operating systems where applicable

            ### 8. Repository Policy
            - **Breaking changes are acceptable** at any time without backward compatibility or migration docs
            - Code formatting is handled by CI (markdownlint-cli2 for MD, Ruff for Python)

            ## Review Instructions

            1. Check that files are in the correct directories
            2. Verify naming conventions are followed
            3. Ensure documentation meets standards (concise, no duplication, ASCII only)
            4. Validate plugin quality requirements for the specific plugin type
            5. Check for security issues, performance problems, or poor error handling
            6. Verify adherence to general principles (modularity, composability, etc.)
            7. Confirm `.claude-plugin/marketplace.json` is updated if new plugins are added

            Use the repository's CLAUDE.md for additional guidance. Be constructive and specific in your feedback, citing which rule was violated.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          # See https://github.com/anthropics/claude-code-action/blob/main/docs/usage.md
          # or https://code.claude.com/docs/en/cli-reference for available options
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

