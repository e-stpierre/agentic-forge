name: analyse-codebase
version: "1.0"
description: Run comprehensive codebase analysis with optional autofix in parallel worktrees

settings:
  max-retry: 2
  timeout-minutes: 120
  track-progress: true
  terminal-output: base

variables:
  - name: autofix
    type: string
    required: false
    default: "none"
    description: Severity level for automatic fixes (none, minor, major, critical)
  - name: paths
    type: string
    required: false
    default: ""
    description: Space-separated list of paths to analyze (optional)
  - name: create_pr
    type: boolean
    required: false
    default: true
    description: Whether to create a PR for each analysis branch

steps:
  - name: analyse-and-fix-all
    type: parallel
    merge-strategy: wait-all
    merge-mode: independent
    git:
      worktree: true
      branch-prefix: "agentic/analysis"
    steps:
      - name: bug-analysis
        type: serial
        steps:
          - name: analyse-bug
            type: command
            command: agentic-sdlc:analyse-bug
            args:
              paths: "{{ variables.paths }}"

          - name: fix-bug
            type: conditional
            condition: "variables.autofix != 'none'"
            then:
              - name: apply-bug-fixes
                type: prompt
                prompt: |
                  Review the bug analysis in agentic/analysis/bug.md.
                  Fix all issues with severity {{ variables.autofix }} or higher.
                  Commit fixes with clear messages.

          - name: create-bug-pr
            type: conditional
            condition: "variables.create_pr"
            then:
              - name: open-bug-pr
                type: command
                command: agentic-sdlc:git-pr
                args:
                  title: "[Analysis] Bug analysis and fixes"
                  draft: false

      - name: debt-analysis
        type: serial
        steps:
          - name: analyse-debt
            type: command
            command: agentic-sdlc:analyse-debt
            args:
              paths: "{{ variables.paths }}"

          - name: fix-debt
            type: conditional
            condition: "variables.autofix != 'none'"
            then:
              - name: apply-debt-fixes
                type: prompt
                prompt: |
                  Review the technical debt analysis in agentic/analysis/debt.md.
                  Fix all issues with severity {{ variables.autofix }} or higher.
                  Commit fixes with clear messages.

          - name: create-debt-pr
            type: conditional
            condition: "variables.create_pr"
            then:
              - name: open-debt-pr
                type: command
                command: agentic-sdlc:git-pr
                args:
                  title: "[Analysis] Technical debt analysis and fixes"
                  draft: false

      - name: doc-analysis
        type: serial
        steps:
          - name: analyse-doc
            type: command
            command: agentic-sdlc:analyse-doc
            args:
              paths: "{{ variables.paths }}"

          - name: fix-doc
            type: conditional
            condition: "variables.autofix != 'none'"
            then:
              - name: apply-doc-fixes
                type: prompt
                prompt: |
                  Review the documentation analysis in agentic/analysis/doc.md.
                  Fix all issues with severity {{ variables.autofix }} or higher.
                  Commit fixes with clear messages.

          - name: create-doc-pr
            type: conditional
            condition: "variables.create_pr"
            then:
              - name: open-doc-pr
                type: command
                command: agentic-sdlc:git-pr
                args:
                  title: "[Analysis] Documentation analysis and fixes"
                  draft: false

      - name: security-analysis
        type: serial
        steps:
          - name: analyse-security
            type: command
            command: agentic-sdlc:analyse-security
            args:
              paths: "{{ variables.paths }}"

          - name: fix-security
            type: conditional
            condition: "variables.autofix != 'none'"
            then:
              - name: apply-security-fixes
                type: prompt
                prompt: |
                  Review the security analysis in agentic/analysis/security.md.
                  Fix all issues with severity {{ variables.autofix }} or higher.
                  Commit fixes with clear messages.

          - name: create-security-pr
            type: conditional
            condition: "variables.create_pr"
            then:
              - name: open-security-pr
                type: command
                command: agentic-sdlc:git-pr
                args:
                  title: "[Analysis] Security analysis and fixes"
                  draft: false

      - name: style-analysis
        type: serial
        steps:
          - name: analyse-style
            type: command
            command: agentic-sdlc:analyse-style
            args:
              paths: "{{ variables.paths }}"

          - name: fix-style
            type: conditional
            condition: "variables.autofix != 'none'"
            then:
              - name: apply-style-fixes
                type: prompt
                prompt: |
                  Review the style analysis in agentic/analysis/style.md.
                  Fix all issues with severity {{ variables.autofix }} or higher.
                  Commit fixes with clear messages.

          - name: create-style-pr
            type: conditional
            condition: "variables.create_pr"
            then:
              - name: open-style-pr
                type: command
                command: agentic-sdlc:git-pr
                args:
                  title: "[Analysis] Style analysis and fixes"
                  draft: false

outputs:
  - name: analysis-summary
    template: analysis-summary.md.j2
    path: summary.md
    when: completed
