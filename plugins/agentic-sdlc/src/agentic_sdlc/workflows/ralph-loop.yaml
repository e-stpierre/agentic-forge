name: ralph-loop
version: "1.0"
description: Workflow using the Ralph Wiggum iterative loop pattern

settings:
  max-retry: 3
  timeout-minutes: 120
  track-progress: true
  bypass-permissions: true
  git:
    enabled: true
    auto-commit: true
    auto-pr: false

variables:
  - name: task
    type: string
    required: true
    description: Task to complete iteratively
  - name: completion_promise
    type: string
    required: false
    default: TASK_COMPLETE
    description: Completion promise text that signals the loop should exit
  - name: max_iterations
    type: number
    required: false
    default: 5
    description: Maximum iterations before stopping

steps:
  - name: iterative-task
    type: ralph-loop
    prompt: |
      ## Ralph Wiggum Loop - Iteration {{iteration}}/{{max_iterations}}

      You are in a Ralph Wiggum iterative loop. Each iteration starts a fresh session.

      ## Task
      {{ variables.task }}

      ## How Iterations Work
      - Each iteration is independent - just STOP when your unit of work is done
      - The loop automatically starts a new iteration after you stop
      - You do NOT need to output anything special to end an iteration - just stop working

      ## Instructions
      1. Analyze the current state of the codebase
      2. Identify what needs to be done next
      3. Make incremental progress on the task
      4. Commit your changes with a clear message
      5. Assess if the task is fully complete

      ## Completion Signal
      When your task is FULLY complete (not just one step), output:
      ```json
      {"ralph_complete": true, "promise": "{{ variables.completion_promise }}"}
      ```

      **IMPORTANT**:
      - Only output the completion JSON when the ENTIRE task is genuinely finished
      - If you're doing iterative work (one item at a time), do NOT output completion after each item
      - Simply STOP after completing your iteration - no special output needed
    max-iterations: "{{ variables.max_iterations }}"
    completion-promise: "{{ variables.completion_promise }}"
    model: sonnet
    timeout-minutes: 30

outputs:
  - name: ralph-report
    template: ralph-report.md.j2
    path: ralph-report.md
    when: completed
