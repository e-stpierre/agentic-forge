name: plan-build-validate
version: "1.0"
description: Full SDLC workflow with planning, implementation, and validation

settings:
  max-retry: 3
  timeout-minutes: 180
  track-progress: true
  git:
    enabled: true
    worktree: true
    auto-commit: true
    auto-pr: true
    branch-prefix: "feature"

variables:
  - name: task
    type: string
    required: true
    description: Feature/task description
  - name: type
    type: string
    required: false
    default: "auto"
    description: Task type (feature, bug, chore, auto)
  - name: fix_severity
    type: string
    required: false
    default: "major"
    description: Minimum severity for auto-fix

steps:
  - name: plan
    type: command
    command: plan
    args:
      type: "{{ variables.type }}"
      context: "{{ variables.task }}"
    checkpoint: true

  - name: implement
    type: ralph-loop
    prompt: |
      Read the plan at agentic/workflows/{{ workflow_id }}/plan.md and implement the next incomplete milestone.

      For each milestone:
      1. Implement all tasks in the milestone
      2. Run tests to verify your changes
      3. Commit your changes with a descriptive message
      4. Mark the milestone as complete in the plan file

      When ALL milestones are marked complete in the plan, output:
      ```json
      {"ralph_complete": true, "promise": "ALL_MILESTONES_COMPLETE"}
      ```

      Do NOT output the completion JSON until every milestone is genuinely finished.
    max-iterations: 10
    completion-promise: "ALL_MILESTONES_COMPLETE"
    model: sonnet
    checkpoint: true

  - name: validate
    type: command
    command: validate
    args:
      plan: "agentic/workflows/{{ workflow_id }}/plan.md"
      severity: minor

  - name: fix-issues
    type: conditional
    condition: "outputs.validate.issues | selectattr('severity', 'ge', variables.fix_severity) | list | length > 0"
    then:
      - name: apply-fixes
        type: prompt
        prompt: |
          Review the validation results and fix all issues with severity {{ variables.fix_severity }} or higher.

          Validation output:
          {{ outputs.validate | tojson }}

          Make the necessary fixes and commit them.
        agent: agents/reviewer.md

      - name: revalidate
        type: command
        command: validate
        args:
          severity: "{{ variables.fix_severity }}"

  - name: create-pr
    type: command
    command: git-pr
    args:
      title: "{{ outputs.plan.summary }}"
      draft: false

outputs:
  - name: implementation-report
    template: implementation-report.md.j2
    path: agentic/workflows/{{ workflow_id }}/report.md
    when: completed
