name: analyze-codebase
version: "1.0"
description: Run comprehensive codebase analysis with optional autofix in parallel worktrees

settings:
  max-retry: 2
  timeout-minutes: 120
  track-progress: true
  terminal-output: base

variables:
  - name: autofix
    type: string
    required: false
    default: "none"
    description: Severity level for automatic fixes (none, minor, major, critical)
  - name: paths
    type: string
    required: false
    default: ""
    description: Space-separated list of paths to analyze (optional)
  - name: create_pr
    type: boolean
    required: false
    default: true
    description: Whether to create a PR for each analysis branch
  - name: max_fix_iterations
    type: number
    required: false
    default: 10
    description: Maximum iterations per analysis type for fixing issues

steps:
  - name: analyze-and-fix-all
    type: parallel
    merge-strategy: wait-all
    merge-mode: independent
    git:
      worktree: true
      branch-prefix: "agentic/analysis"
    steps:
      - name: bug-analysis
        type: serial
        steps:
          - name: analyze-bug
            type: command
            command: analyze-bug
            args:
              paths: "{{ variables.paths }}"

          - name: fix-bug
            type: conditional
            condition: "variables.autofix != 'none'"
            then:
              - name: apply-bug-fixes
                type: ralph-loop
                max-iterations: "{{ variables.max_fix_iterations }}"
                completion-promise: "BUG_FIXES_COMPLETE"
                model: sonnet
                timeout-minutes: 30
                prompt: |
                  ## Task
                  Fix issues from the bug analysis document.

                  ## Instructions
                  1. Read the analysis document at agentic/analysis/bug.md
                  2. If the document does not exist or has no unfixed issues, return the completion promise
                  3. Pick the NEXT unfixed issue (highest severity first, must be {{ variables.autofix }} or higher)
                  4. Navigate the code to understand the issue context
                  5. Implement the fix
                  6. Run build/lint commands and fix any errors
                  7. Mark the issue as fixed in the analysis document
                  8. Commit using git-commit with title starting with issue ID
                  9. End this session (do NOT continue to next issue)

                  ## Completion
                  When ALL issues with severity {{ variables.autofix }} or higher are fixed OR the document doesn't exist, output:
                  ```json
                  {"ralph_complete": true, "promise": "BUG_FIXES_COMPLETE"}
                  ```

                  IMPORTANT:
                  - Fix only ONE issue per iteration, then end session
                  - If an issue cannot be fixed (error, missing data), mark as skipped with reason
                  - Only return completion promise when genuinely done

          - name: create-bug-pr
            type: conditional
            condition: "variables.create_pr"
            then:
              - name: open-bug-pr
                type: command
                command: git-pr
                args:
                  title: "[Analysis] Bug analysis and fixes"
                  draft: false

      - name: debt-analysis
        type: serial
        steps:
          - name: analyze-debt
            type: command
            command: analyze-debt
            args:
              paths: "{{ variables.paths }}"

          - name: fix-debt
            type: conditional
            condition: "variables.autofix != 'none'"
            then:
              - name: apply-debt-fixes
                type: ralph-loop
                max-iterations: "{{ variables.max_fix_iterations }}"
                completion-promise: "DEBT_FIXES_COMPLETE"
                model: sonnet
                timeout-minutes: 30
                prompt: |
                  ## Task
                  Fix issues from the technical debt analysis document.

                  ## Instructions
                  1. Read the analysis document at agentic/analysis/debt.md
                  2. If the document does not exist or has no unfixed issues, return the completion promise
                  3. Pick the NEXT unfixed issue (highest severity first, must be {{ variables.autofix }} or higher)
                  4. Navigate the code to understand the issue context
                  5. Implement the fix
                  6. Run build/lint commands and fix any errors
                  7. Mark the issue as fixed in the analysis document
                  8. Commit using git-commit with title starting with issue ID
                  9. End this session (do NOT continue to next issue)

                  ## Completion
                  When ALL issues with severity {{ variables.autofix }} or higher are fixed OR the document doesn't exist, output:
                  ```json
                  {"ralph_complete": true, "promise": "DEBT_FIXES_COMPLETE"}
                  ```

                  IMPORTANT:
                  - Fix only ONE issue per iteration, then end session
                  - If an issue cannot be fixed (error, missing data), mark as skipped with reason
                  - Only return completion promise when genuinely done

          - name: create-debt-pr
            type: conditional
            condition: "variables.create_pr"
            then:
              - name: open-debt-pr
                type: command
                command: git-pr
                args:
                  title: "[Analysis] Technical debt analysis and fixes"
                  draft: false

      - name: doc-analysis
        type: serial
        steps:
          - name: analyze-doc
            type: command
            command: analyze-doc
            args:
              paths: "{{ variables.paths }}"

          - name: fix-doc
            type: conditional
            condition: "variables.autofix != 'none'"
            then:
              - name: apply-doc-fixes
                type: ralph-loop
                max-iterations: "{{ variables.max_fix_iterations }}"
                completion-promise: "DOC_FIXES_COMPLETE"
                model: sonnet
                timeout-minutes: 30
                prompt: |
                  ## Task
                  Fix issues from the documentation analysis document.

                  ## Instructions
                  1. Read the analysis document at agentic/analysis/doc.md
                  2. If the document does not exist or has no unfixed issues, return the completion promise
                  3. Pick the NEXT unfixed issue (highest severity first, must be {{ variables.autofix }} or higher)
                  4. Navigate the code to understand the issue context
                  5. Implement the fix
                  6. Run build/lint commands and fix any errors
                  7. Mark the issue as fixed in the analysis document
                  8. Commit using git-commit with title starting with issue ID
                  9. End this session (do NOT continue to next issue)

                  ## Completion
                  When ALL issues with severity {{ variables.autofix }} or higher are fixed OR the document doesn't exist, output:
                  ```json
                  {"ralph_complete": true, "promise": "DOC_FIXES_COMPLETE"}
                  ```

                  IMPORTANT:
                  - Fix only ONE issue per iteration, then end session
                  - If an issue cannot be fixed (error, missing data), mark as skipped with reason
                  - Only return completion promise when genuinely done

          - name: create-doc-pr
            type: conditional
            condition: "variables.create_pr"
            then:
              - name: open-doc-pr
                type: command
                command: git-pr
                args:
                  title: "[Analysis] Documentation analysis and fixes"
                  draft: false

      - name: security-analysis
        type: serial
        steps:
          - name: analyze-security
            type: command
            command: analyze-security
            args:
              paths: "{{ variables.paths }}"

          - name: fix-security
            type: conditional
            condition: "variables.autofix != 'none'"
            then:
              - name: apply-security-fixes
                type: ralph-loop
                max-iterations: "{{ variables.max_fix_iterations }}"
                completion-promise: "SECURITY_FIXES_COMPLETE"
                model: sonnet
                timeout-minutes: 30
                prompt: |
                  ## Task
                  Fix issues from the security analysis document.

                  ## Instructions
                  1. Read the analysis document at agentic/analysis/security.md
                  2. If the document does not exist or has no unfixed issues, return the completion promise
                  3. Pick the NEXT unfixed issue (highest severity first, must be {{ variables.autofix }} or higher)
                  4. Navigate the code to understand the issue context
                  5. Implement the fix
                  6. Run build/lint commands and fix any errors
                  7. Mark the issue as fixed in the analysis document
                  8. Commit using git-commit with title starting with issue ID
                  9. End this session (do NOT continue to next issue)

                  ## Completion
                  When ALL issues with severity {{ variables.autofix }} or higher are fixed OR the document doesn't exist, output:
                  ```json
                  {"ralph_complete": true, "promise": "SECURITY_FIXES_COMPLETE"}
                  ```

                  IMPORTANT:
                  - Fix only ONE issue per iteration, then end session
                  - If an issue cannot be fixed (error, missing data), mark as skipped with reason
                  - Only return completion promise when genuinely done

          - name: create-security-pr
            type: conditional
            condition: "variables.create_pr"
            then:
              - name: open-security-pr
                type: command
                command: git-pr
                args:
                  title: "[Analysis] Security analysis and fixes"
                  draft: false

      - name: style-analysis
        type: serial
        steps:
          - name: analyze-style
            type: command
            command: analyze-style
            args:
              paths: "{{ variables.paths }}"

          - name: fix-style
            type: conditional
            condition: "variables.autofix != 'none'"
            then:
              - name: apply-style-fixes
                type: ralph-loop
                max-iterations: "{{ variables.max_fix_iterations }}"
                completion-promise: "STYLE_FIXES_COMPLETE"
                model: sonnet
                timeout-minutes: 30
                prompt: |
                  ## Task
                  Fix issues from the style analysis document.

                  ## Instructions
                  1. Read the analysis document at agentic/analysis/style.md
                  2. If the document does not exist or has no unfixed issues, return the completion promise
                  3. Pick the NEXT unfixed issue (highest severity first, must be {{ variables.autofix }} or higher)
                  4. Navigate the code to understand the issue context
                  5. Implement the fix
                  6. Run build/lint commands and fix any errors
                  7. Mark the issue as fixed in the analysis document
                  8. Commit using git-commit with title starting with issue ID
                  9. End this session (do NOT continue to next issue)

                  ## Completion
                  When ALL issues with severity {{ variables.autofix }} or higher are fixed OR the document doesn't exist, output:
                  ```json
                  {"ralph_complete": true, "promise": "STYLE_FIXES_COMPLETE"}
                  ```

                  IMPORTANT:
                  - Fix only ONE issue per iteration, then end session
                  - If an issue cannot be fixed (error, missing data), mark as skipped with reason
                  - Only return completion promise when genuinely done

          - name: create-style-pr
            type: conditional
            condition: "variables.create_pr"
            then:
              - name: open-style-pr
                type: command
                command: git-pr
                args:
                  title: "[Analysis] Style analysis and fixes"
                  draft: false

outputs:
  - name: analysis-summary
    template: analysis-summary.md.j2
    path: summary.md
    when: completed
