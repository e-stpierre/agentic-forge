name: plan-build-review
version: "1.0"
description: Full SDLC workflow with planning, implementation, and review

settings:
  max-retry: 3
  timeout-minutes: 180
  track-progress: true
  git:
    enabled: true
    worktree: true
    auto-commit: true
    branch-prefix: "feature"

variables:
  - name: task
    type: string
    required: true
    description: Feature/task description
  - name: type
    type: string
    required: false
    default: "auto"
    description: Task type (feature, bug, chore, auto)
  - name: fix_severity
    type: string
    required: false
    default: "major"
    description: Minimum severity for auto-fix
  - name: explore_agents
    type: integer
    required: false
    default: 0
    description: Number of explore agents for codebase analysis (0=quick main session, 1+=parallel agents)
  - name: create_pr
    type: boolean
    required: false
    default: true
    description: Whether to create a PR

steps:
  - name: plan
    type: prompt
    prompt: /agentic-sdlc:plan {{ workflow_id }} {{ variables.type }} "agentic/outputs/{{ workflow_id }}" {{ variables.explore_agents }} {{ variables.task }}
    checkpoint: true

  - name: review
    type: prompt
    prompt: /agentic-sdlc:git-branch {{ variables.type }}

  - name: implement
    type: ralph-loop
    prompt: |
      Read the plan at agentic/outputs/{{ workflow_id }}/plan.md and implement the next incomplete milestone.

      For each milestone:
      1. Implement all tasks in the milestone
      2. Run tests to verify your changes
      3. use the /agentic-sdlc:git-commit skill to commit your changes with a descriptive message
      4. Mark the milestone as complete in the plan file

      When ALL milestones are marked complete in the plan, output:
      ```json
      {"ralph_complete": true, "promise": "ALL_MILESTONES_COMPLETE"}
      ```

      Do NOT output the completion JSON until every milestone is genuinely finished.
    max-iterations: 10
    completion-promise: "ALL_MILESTONES_COMPLETE"
    model: sonnet
    checkpoint: true

  - name: review
    type: prompt
    prompt: /agentic-sdlc:review "agentic/outputs/{{ workflow_id }}/plan.md" minor

  - name: fix-issues
    type: conditional
    condition: "outputs.review.issues | selectattr('severity', 'ge', variables.fix_severity) | list | length > 0"
    then:
      - name: apply-fixes
        type: prompt
        prompt: |
          Review the validation results and fix all issues with severity {{ variables.fix_severity }} or higher.

          Review output:
          {{ outputs.review | tojson }}

          Make the necessary fixes and commit them.
        agent: agents/reviewer.md

      - name: re-review
        type: prompt
        prompt: /agentic-sdlc:review "" {{ variables.fix_severity }}

  - name: create-pr
    type: conditional
    condition: "variables.create_pr"
    then:
      - name: open-pr
        type: prompt
        prompt: /agentic-sdlc:git-pr "{{ outputs.plan.summary }}"

outputs:
  - name: implementation-report
    template: implementation-report.md.j2
    path: report.md
    when: completed
