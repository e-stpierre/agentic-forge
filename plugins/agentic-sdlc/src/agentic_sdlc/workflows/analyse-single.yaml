name: analyse-single
version: "1.0"
description: Run a single type of codebase analysis with optional autofix

settings:
  max-retry: 2
  timeout-minutes: 60
  track-progress: true
  terminal-output: base

variables:
  - name: analysis_type
    type: string
    required: true
    description: Type of analysis to run (bug, debt, doc, security, style)
  - name: autofix
    type: string
    required: false
    default: "none"
    description: Severity level for automatic fixes (none, minor, major, critical)
  - name: paths
    type: string
    required: false
    default: ""
    description: Space-separated list of paths to analyze (optional)
  - name: max_fix_iterations
    type: number
    required: false
    default: 10
    description: Maximum iterations for fixing issues

steps:
  - name: run-bug-analysis
    type: conditional
    condition: "variables.analysis_type == 'bug'"
    then:
      - name: analyse-bug
        type: command
        command: agentic-sdlc:analyse-bug
        args:
          paths: "{{ variables.paths }}"

  - name: run-debt-analysis
    type: conditional
    condition: "variables.analysis_type == 'debt'"
    then:
      - name: analyse-debt
        type: command
        command: agentic-sdlc:analyse-debt
        args:
          paths: "{{ variables.paths }}"

  - name: run-doc-analysis
    type: conditional
    condition: "variables.analysis_type == 'doc'"
    then:
      - name: analyse-doc
        type: command
        command: agentic-sdlc:analyse-doc
        args:
          paths: "{{ variables.paths }}"

  - name: run-security-analysis
    type: conditional
    condition: "variables.analysis_type == 'security'"
    then:
      - name: analyse-security
        type: command
        command: agentic-sdlc:analyse-security
        args:
          paths: "{{ variables.paths }}"

  - name: run-style-analysis
    type: conditional
    condition: "variables.analysis_type == 'style'"
    then:
      - name: analyse-style
        type: command
        command: agentic-sdlc:analyse-style
        args:
          paths: "{{ variables.paths }}"

  - name: check-autofix
    type: conditional
    condition: "variables.autofix != 'none'"
    then:
      - name: fix-issues
        type: ralph-loop
        max-iterations: "{{ variables.max_fix_iterations }}"
        completion-promise: "ANALYSIS_FIXES_COMPLETE"
        model: sonnet
        timeout-minutes: 30
        prompt: |
          ## Task
          Fix issues from the {{ variables.analysis_type }} analysis document.

          ## Instructions
          1. Read the analysis document at agentic/analysis/{{ variables.analysis_type }}.md
          2. If the document does not exist or has no unfixed issues, return the completion promise
          3. Pick the NEXT unfixed issue (highest severity first, must be {{ variables.autofix }} or higher)
          4. Navigate the code to understand the issue context
          5. Implement the fix
          6. Run build/lint commands and fix any errors
          7. Mark the issue as fixed in the analysis document
          8. Commit using agentic-sdlc:git-commit with title starting with issue ID
          9. End this session (do NOT continue to next issue)

          ## Completion
          When ALL issues with severity {{ variables.autofix }} or higher are fixed OR the document doesn't exist, output:
          ```json
          {"ralph_complete": true, "promise": "ANALYSIS_FIXES_COMPLETE"}
          ```

          IMPORTANT:
          - Fix only ONE issue per iteration, then end session
          - If an issue cannot be fixed (error, missing data), mark as skipped with reason
          - Only return completion promise when genuinely done

outputs:
  - name: analysis-report
    template: analysis/{{ variables.analysis_type }}.md.j2
    path: "{{ variables.analysis_type }}.md"
    when: completed
